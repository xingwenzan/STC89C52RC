//
// Created by 86159 on 2023-11-23.
//
#include "mcs51/reg51.h"
#include "../lib/T6963C.h"

typedef unsigned int u16;
typedef unsigned char u8;
//引脚定义
#define GAME_CD P3_5
#define GAME_RD P3_7
#define GAME_WR P3_6
#define Pin P0

const u8 TabChinese[] =
        {
//0全白
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,//80
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//1人物
                0x01, 0x03, 0x04, 0x0D, 0x04, 0x03, 0x07, 0x07,//84
                0x0F, 0x1B, 0x33, 0xE3, 0xC3, 0x06, 0x06, 0x0E,
                0x00, 0x80, 0x40, 0x60, 0x40, 0x80, 0xC0, 0xC0,
                0xE0, 0xB0, 0x98, 0x8E, 0x86, 0xC0, 0xC0, 0xE0,
//-- 推 --
                0x10, 0x10, 0x10, 0x11, 0xFD, 0x13, 0x15, 0x19,//88
                0x31, 0xD1, 0x11, 0x11, 0x11, 0x11, 0x51, 0x21,
                0xA0, 0x90, 0x84, 0xFE, 0x10, 0x10, 0xFC, 0x10,
                0x10, 0xFC, 0x10, 0x10, 0x14, 0xFF, 0x00, 0x00,
//-- 箱 --
                0x12, 0x1F, 0x28, 0x45, 0x08, 0x08, 0xFE, 0x08,//8C
                0x18, 0x1C, 0x2A, 0x28, 0x48, 0x88, 0x08, 0x08,
                0x44, 0x7E, 0xA0, 0x10, 0x04, 0xFE, 0x84, 0x84,
                0xFC, 0x84, 0x84, 0xFC, 0x84, 0x84, 0xFC, 0x84,
//-- 子 --
                0x00, 0x3F, 0x00, 0x00, 0x00, 0x01, 0x01, 0xFF,//90
                0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x05, 0x02,
                0x00, 0xF0, 0x10, 0x20, 0x40, 0x80, 0x04, 0xFE,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//-- 游 --
                0x02, 0x41, 0x20, 0x2F, 0x82, 0x62, 0x23, 0x02,//94
                0x12, 0x22, 0xE2, 0x24, 0x24, 0x28, 0x31, 0x20,
                0x10, 0x14, 0x1E, 0xE0, 0x40, 0x3E, 0x84, 0x88,
                0x88, 0xFE, 0x88, 0x88, 0x88, 0x88, 0xA8, 0x10,
//-- 戏 --
                0x00, 0x00, 0x7E, 0x02, 0x43, 0x24, 0x14, 0x14,//98
                0x08, 0x14, 0x12, 0x22, 0x40, 0x80, 0x01, 0x02,
                0x40, 0x50, 0x48, 0x40, 0xFE, 0x40, 0x44, 0x44,
                0x48, 0x48, 0x50, 0x20, 0x60, 0x92, 0x0A, 0x06,
//81-- 笨 --
                0x08, 0x0A, 0x1F, 0x28, 0x45, 0x01, 0x7F, 0x03,//9C
                0x05, 0x09, 0x11, 0x2F, 0xC1, 0x01, 0x01, 0x01,
                0x40, 0x48, 0x7C, 0xA0, 0x10, 0x00, 0xFC, 0x80,
                0x40, 0x20, 0x10, 0xEE, 0x04, 0x00, 0x00, 0x00,
//85-- 小 --
                0x01, 0x01, 0x01, 0x01, 0x01, 0x05, 0x05, 0x09,//A0
                0x09, 0x11, 0x21, 0x41, 0x01, 0x01, 0x05, 0x02,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x20, 0x10,
                0x08, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00,
//89-- 孩 --
                0x00, 0xFC, 0x04, 0x0B, 0x10, 0x10, 0x15, 0x1B,//A4
                0x31, 0xD0, 0x10, 0x11, 0x16, 0x10, 0x51, 0x26,
                0x80, 0x40, 0x04, 0xFE, 0x40, 0x80, 0x08, 0xF8,
                0x10, 0x24, 0x4C, 0x90, 0x20, 0x50, 0x8C, 0x04,
//-- 编 --
                0x10, 0x10, 0x23, 0x22, 0x4A, 0xFB, 0x12, 0x22,//A8
                0x43, 0xF6, 0x4A, 0x03, 0x1A, 0xE2, 0x42, 0x02,
                0x80, 0x48, 0xFC, 0x08, 0x08, 0xF8, 0x00, 0x04,
                0xFE, 0x94, 0x94, 0xFC, 0x94, 0x94, 0x94, 0x0C,
//95-- 重 --
                0x00, 0x3F, 0x01, 0xFF, 0x01, 0x1F, 0x11, 0x1F,//AC
                0x11, 0x1F, 0x01, 0x3F, 0x01, 0x01, 0xFF, 0x00,
                0x38, 0xC0, 0x04, 0xFE, 0x10, 0xF8, 0x10, 0xF0,
                0x10, 0xF0, 0x00, 0xF8, 0x00, 0x04, 0xFE, 0x00,
//99-- 温 --
                0x00, 0x43, 0x32, 0x12, 0x83, 0x62, 0x22, 0x0B,//B0
                0x10, 0x27, 0xE4, 0x24, 0x24, 0x24, 0x2F, 0x20,
                0x08, 0xFC, 0x08, 0x08, 0xF8, 0x08, 0x08, 0xF8,
                0x00, 0xFC, 0xA4, 0xA4, 0xA4, 0xA4, 0xFE, 0x00,
//9d-- 童 --
                0x02, 0x01, 0x3F, 0x08, 0x04, 0xFF, 0x00, 0x1F,//B4
                0x11, 0x1F, 0x11, 0x1F, 0x01, 0x3F, 0x01, 0x7F,
                0x00, 0x10, 0xF8, 0x20, 0x44, 0xFE, 0x10, 0xF8,
                0x10, 0xF0, 0x10, 0xF0, 0x00, 0xF8, 0x00, 0xFC,
//a1-- 年 --
                0x08, 0x08, 0x1F, 0x11, 0x21, 0x41, 0x1F, 0x11,//B8
                0x11, 0x11, 0xFF, 0x01, 0x01, 0x01, 0x01, 0x01,
                0x00, 0x08, 0xFC, 0x00, 0x00, 0x10, 0xF8, 0x00,
                0x00, 0x04, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00,
//a5-- 的 --
                0x10, 0x10, 0x22, 0x7F, 0x42, 0x43, 0x42, 0x42,//BC
                0x7E, 0x42, 0x42, 0x42, 0x42, 0x7E, 0x42, 0x00,
                0x40, 0x40, 0x44, 0x7E, 0x84, 0x04, 0x04, 0x84,
                0x64, 0x24, 0x04, 0x04, 0x04, 0x04, 0x28, 0x10,
//a9-- 经 --
                0x10, 0x13, 0x20, 0x20, 0x44, 0xFC, 0x08, 0x13,//C0
                0x20, 0x41, 0xFC, 0x00, 0x1C, 0xE0, 0x47, 0x00,
                0x00, 0xFC, 0x08, 0x10, 0x30, 0x48, 0x86, 0x02,
                0x00, 0xFC, 0x20, 0x20, 0x20, 0x24, 0xFE, 0x00,
//b1-- 典 --
                0x04, 0x04, 0x04, 0x3F, 0x24, 0x24, 0x24, 0x3F,//C4
                0x24, 0x24, 0x24, 0xFF, 0x00, 0x10, 0x30, 0x40,
                0x40, 0x40, 0x48, 0xFC, 0x48, 0x48, 0x48, 0xF8,
                0x48, 0x48, 0x48, 0xFE, 0x00, 0x10, 0x0C, 0x04,
//b5-- 挑 --
                0x10, 0x10, 0x10, 0x10, 0xFC, 0x12, 0x15, 0x18,//C8
                0x31, 0xD2, 0x14, 0x11, 0x11, 0x12, 0x54, 0x28,
                0xA0, 0xA0, 0xA0, 0xA0, 0xA4, 0xAC, 0xB0, 0xA0,
                0xB0, 0xA8, 0xA8, 0x20, 0x22, 0x22, 0x1E, 0x00,
//b9-- 战 --
                0x10, 0x10, 0x12, 0x1F, 0x10, 0x13, 0x10, 0x7E,//CC
                0x42, 0x42, 0x42, 0x42, 0x42, 0x7E, 0x41, 0x02,
                0x40, 0x50, 0x48, 0x48, 0x7E, 0xC0, 0x40, 0x40,
                0x48, 0x28, 0x30, 0x20, 0x50, 0x92, 0x0A, 0x06,
//bd-- 智 --
                0x20, 0x22, 0x3F, 0x48, 0x08, 0xFF, 0x10, 0x14,//D0
                0x22, 0x42, 0x9F, 0x10, 0x1F, 0x10, 0x1F, 0x10,
                0x00, 0x04, 0x7E, 0x44, 0x44, 0xC4, 0x44, 0x7C,
                0x44, 0x10, 0xF8, 0x10, 0xF0, 0x10, 0xF0, 0x10,
//c1-- 力 --
                0x02, 0x02, 0x02, 0x02, 0x7F, 0x02, 0x02, 0x02,//D4
                0x02, 0x02, 0x02, 0x04, 0x04, 0x08, 0x08, 0x70,
                0x00, 0x00, 0x00, 0x08, 0xFC, 0x08, 0x08, 0x08,
                0x08, 0x08, 0x08, 0x08, 0x08, 0x88, 0x50, 0x20,
//c5-- 极 --
                0x10, 0x17, 0x11, 0x11, 0xFD, 0x11, 0x31, 0x39,//D8
                0x55, 0x51, 0x92, 0x12, 0x12, 0x14, 0x19, 0x12,
                0x08, 0xFC, 0x08, 0x08, 0x10, 0x10, 0x3C, 0x84,
                0x88, 0x48, 0x50, 0x20, 0x50, 0x88, 0x0E, 0x04,
//c9-- 限 --
                0x00, 0x7D, 0x45, 0x49, 0x49, 0x51, 0x49, 0x49,//DC
                0x45, 0x45, 0x45, 0x69, 0x51, 0x41, 0x41, 0x41,
                0x08, 0xFC, 0x08, 0x08, 0xF8, 0x08, 0x08, 0xF8,
                0x04, 0x88, 0x50, 0x20, 0x10, 0x4E, 0x84, 0x00,
        };

u16 GetGameTextByteCount() {
    return sizeof(TabChinese);
}

//读状态函数
unsigned char Read_State() {
    Pin = 0xff;//读状态之前先将数据线拉高
    GAME_CD = 1;
    GAME_RD = 0;
    GAME_RD = 1;
    return Pin;
}

//bit0指令写状态位,bit1数据读/写状态位,为1时候空闲
void Enable() {
    while (1)
        if ((Read_State() & 3) == 3)break;
}

//bit3数据自动写状态位,为1时候空闲
void Aut_Write() {
    while (1)
        if ((Read_State() & 8) == 8)break;
}

//写单参数函数,Data1为传入的参数，Com为传入的指令
//注意：写入顺序为先数据后写指令，不可颠倒
void Write_Data1(unsigned char Data1, unsigned char Com) {
    Enable();
    GAME_CD = 0;
    Pin = Data1;
    GAME_WR = 0;
    GAME_WR = 1;
    Enable();
    GAME_CD = 1;
    Pin = Com;
    GAME_WR = 0;
    GAME_WR = 1;
}

//写双参数函数,Data1/Data2为传入的参数，Com为传入的指令
//注意：写入顺序为先数据Data1后写数据Data2,最后写指令，不可颠倒
void Write_Data2(unsigned char Data1, unsigned char Data2, unsigned char Com) {
    Enable();
    GAME_CD = 0;
    Pin = Data1;
    GAME_WR = 0;
    GAME_WR = 1;
    Enable();
    GAME_CD = 0;
    Pin = Data2;
    GAME_WR = 0;
    GAME_WR = 1;
    Enable();
    GAME_CD = 1;
    Pin = Com;
    GAME_WR = 0;
    GAME_WR = 1;
}

//写指令函数
void Write_Com(unsigned char Com) {
    Enable();
    GAME_CD = 1;
    Pin = Com;
    GAME_WR = 0;
    GAME_WR = 1;
}

//写8字节数据函数Addr表示数据首地址，Way表示写的方式
void Write_8_Data(unsigned char Addr, unsigned char Way) {
    Aut_Write();//判断是否能自动写
    Write_Com(AUT_WR);//自动写开始
    Write_Data1(Addr, Way);
    Write_Com(AUT_WO);//自动写结束
}

//设置数据显示在屏幕上的坐标(以字节为单位)
//x表示显示的行(0~15)，y表示显示的列(0~19)
void Set_xy(unsigned char x, unsigned char y) {
    unsigned int a;
    a = x * 32 + y;
    Write_Data2(a & 0xff, a >> 8, ADR_POS);
}

/*自定义字符写入CGROM函数*/
void Write_CGORM(u8 pCode, u16 nSize) {
    Write_Data2(3, 0, CGR_POS);
    Write_Data2(0, 0x1c, ADR_POS);
    while (nSize--)
        Write_8_Data(pCode++, INC_WR);
}

//液晶初始化函数
//(文本区首地址D1,文本区首地址D2, 文本区宽度,
//图形区首地址D1, 图形区首地址D2, 图形区宽度,
//光标形状,  显示方式,  显示开关)
void GameLCDInit() {
    Write_Data2(0, 0, TXT_STP);
    Write_Data2(0x20, 0, TXT_WID);
    Write_Data2(0x00, 0x20, GRH_STP);
    Write_Data2(0x20, 0, GRH_WID);
    Write_Com(CUR_SHP | 1);
    Write_Com(MOD_XOR);
    Write_Com(DIS_SW | 0x0C);
}

//显示一个汉字子程序,
//x表示显示的行(0~15)，y表示显示的列(0~19),n表示字在表格中的位置
void Han_Zi(unsigned char x, unsigned char y, unsigned char Addr) {
    Set_xy(x, y);
    Write_8_Data(Addr, INC_WR);
    Write_8_Data(Addr + 2, INC_WR);
    Set_xy(x + 1, y);
    Write_8_Data(Addr + 1, INC_WR);
    Write_8_Data(Addr + 3, INC_WR);
}

//清屏程序
void Clear_LCD() {
    unsigned int a = 1024;
    Set_xy(0, 0);
    while (a--)
        Write_8_Data(0x83, INC_WR);
}

//设置点显示在屏幕上的坐标(以位为单位)
//x表示显示的行(0~127)，y表示显示的列(0~159),n=1表示打个点,n=0清除一个点
void Point(unsigned char x, unsigned char y, u8 n) {
    unsigned char point;
    unsigned int temp = x;
    temp <<= 5;
    temp += (y >> 3);
    temp += 0x2000;    //加图形首地址
    point = 0xf7 - y % 8;
    if (n)point |= 0xf8;
    else point &= 0xf7;
    Write_Data2(temp & 0xff, temp >> 8, 0x24);    //设置写地址
    Write_Com(point);
}

//显示一个图形
void DrawGameGraph(unsigned char x, unsigned char y, unsigned char Addr) {
    u8 i;
    for (i = 0; i < 4; ++i) {
        Set_xy((y << 2) + i, x << 2);
        Write_8_Data(Addr + i, INC_WR);
        Write_8_Data(Addr + 4 + i, INC_WR);
        Write_8_Data(Addr + 8 + i, INC_WR);
        Write_8_Data(Addr + 12 + i, INC_WR);
    }
}

//画圆子程序，其中x0,y0表示圆心，R表示半径
//圆方程为(x-x0)^2+(y-y0)^2=R^2
//先打第一象限内的1/4段圆弧(顺时针和反时针各打一次)，再依据对称原理打出其他3段圆弧
void Circle(unsigned char x0, unsigned char y0, unsigned char R, u8 n) {
    unsigned char i, j = 0;
    Point(x0, y0, n);
    for (i = 0; i <= R; i++) {
        while (1) {
            if (R * R - i * i <= j * j)break;
            j++;
        }
        //第一象限打点
        Point(x0 - j, y0 + i, n);
        Point(x0 - i, y0 + j, n);
        //Delay_500ms();
        //第二象限打点
        Point(x0 + j, y0 + i, n);
        Point(x0 + i, y0 + j, n);
        //Delay_500ms();
        //第三象限打点
        Point(x0 + j, y0 - i, n);
        Point(x0 + i, y0 - j, n);
        // Delay_500ms();
        //第四象限打点
        Point(x0 - j, y0 - i, n);
        Point(x0 - i, y0 - j, n);
        //Delay_500ms();
        j = 0;
    }
}

int main() {
    GameLCDInit();
    Write_Data2(3, 0, CGR_POS);
    Write_Data2(0, 0x1c, ADR_POS);
    for (int i = 0; i < GetGameTextByteCount(); ++i) {
        Write_8_Data(TabChinese[i], INC_WR);
    }
    Han_Zi(9, 13, TabChinese[71]);
    Han_Zi(9, 15, TabChinese[103]);
    Circle(100, 100, 20, 1);
    return 0;
}